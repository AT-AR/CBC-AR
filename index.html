<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>テレビ塔上空ARロゴ</title>
  <style>
    html, body { margin: 0; overflow: hidden; background: black; }
    video { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: -1; }
    canvas { position: fixed; top: 0; left: 0; }
  </style>
</head>
<body>
  <video id="bgvideo" autoplay playsinline muted></video>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>

  <script>
    let scene, camera, renderer, logoMesh;

    // テレビ塔の位置
    const towerLat = 35.1709;
    const towerLon = 136.9066;

    let userLat = null;
    let userLon = null;

    // カメラ映像
    const video = document.getElementById("bgvideo");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => alert("カメラを使えません：" + err.message));

    // Three.js 初期化
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
    renderer = new THREE.WebGLRenderer({ alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // ロゴ作成
    const texture = new THREE.TextureLoader().load("assets/cbc_logo.png");
    const geometry = new THREE.PlaneGeometry(100, 100); // 100m相当
    const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide });
    logoMesh = new THREE.Mesh(geometry, material);
    logoMesh.visible = false;
    scene.add(logoMesh);

    // 緯度経度から距離と方位
    function toRadians(deg) { return deg * Math.PI / 180; }
    function toDegrees(rad) { return rad * 180 / Math.PI; }

    function getBearing(lat1, lon1, lat2, lon2) {
      const dLon = toRadians(lon2 - lon1);
      const y = Math.sin(dLon) * Math.cos(toRadians(lat2));
      const x = Math.cos(toRadians(lat1)) * Math.sin(toRadians(lat2)) -
                Math.sin(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.cos(dLon);
      return (toDegrees(Math.atan2(y, x)) + 360) % 360;
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = toRadians(lat2 - lat1);
      const dLon = toRadians(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // ロゴの3D位置を決定
    function updateLogoPosition() {
      if (userLat === null || userLon === null) return;
      const distance = getDistance(userLat, userLon, towerLat, towerLon);
      const bearing = getBearing(userLat, userLon, towerLat, towerLon);
      const bearingRad = toRadians(bearing);

      const x = Math.sin(bearingRad) * distance;
      const z = -Math.cos(bearingRad) * distance;
      const y = 200; // 高さ200mに浮かせる

      logoMesh.position.set(x, y, z);
      logoMesh.visible = true;
    }

    // GPS位置取得
    navigator.geolocation.watchPosition(pos => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      updateLogoPosition();
    });

    // ロゴ回転
    function animate() {
      requestAnimationFrame(animate);
      if (logoMesh) logoMesh.rotation.y += 0.01;
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
